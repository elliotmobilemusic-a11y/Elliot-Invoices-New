<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elliot Wardill Invoice Generator</title>
  <link rel="icon" type="image/png" href="i-favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Print styles */
    @media print {
      body { background: white; font-size: 10pt; }
      .no-print { display: none !important; }
      .invoice-container { box-shadow: none !important; border: none !important; margin: 0; padding: 0; }
      .text-gray-700, .text-gray-900 { color: #000 !important; }
      /* Ensure table headers print */
      thead { display: table-header-group; }
    }

    /* Small custom refinements */
    body { font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background-color: #eef2ff; } /* subtle indigo-50 */
    .invoice-wrapper { max-width: 1100px; margin: 2.5rem auto; padding: 1rem; }
    .invoice-container { background: white; border-radius: 1rem; padding: 1.25rem; box-shadow: 0 8px 24px rgba(15,23,42,0.06); border: 1px solid rgba(99,102,241,0.06); }
    .card { border-radius: 0.75rem; }
    .desc-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 34rem; display: inline-block; }
    /* Make interactive controls comfortably large for touch */
    .btn { min-height: 44px; display: inline-flex; align-items: center; justify-content: center; }
    /* Table scroll on mobile */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    /* Sticky header on desktop */
    @media (min-width: 768px) {
      thead th { position: sticky; top: 0; background: #eef2ff; z-index: 10; }
    }
  </style>
</head>
<body>

<div class="invoice-wrapper">
  <div class="invoice-container card">

    <!-- HEADER -->
    <header class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start pb-4 border-b border-indigo-100">
      <div>
        <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-700 tracking-tight">INVOICE</h1>
        <div class="mt-3 flex items-center text-sm text-indigo-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 002-2V8H3v11a2 2 0 002 2z"/>
          </svg>
          <span id="invoice-date" class="font-medium">October 18, 2025</span>
        </div>
      </div>

      <div class="text-left md:text-right">
        <div class="font-semibold text-lg text-gray-800">Elliot Wardill Mobile Music Lessons</div>
        <div class="text-sm text-gray-600 mt-1">Pudsey, UK</div>
        <div class="text-sm text-gray-600">elliotmobilemusic@gmail.com</div>
        <div class="text-sm text-gray-600">07368 975144</div>
      </div>
    </header>

    <!-- CLIENT + INVOICE DETAILS (card) -->
    <section class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-white card border border-indigo-50">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">BILL TO:</h3>
        <input id="client-name" type="text" placeholder="Client Full Name" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-200 mb-3" />
        <input id="client-address" type="text" placeholder="Address, Postcode" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-200" />
      </div>

      <div class="p-4 bg-white card border border-indigo-50">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">INVOICE DETAILS:</h3>
        <div class="grid grid-cols-2 gap-3">
          <input id="invoice-number" type="text" value="EW-" class="p-3 border border-gray-200 rounded-lg text-right focus:ring-2 focus:ring-indigo-200" />
          <div class="p-3 border border-gray-100 rounded-lg bg-indigo-50 text-sm text-gray-700">DUE DATE: <input id="due-date" type="date" class="ml-2 text-sm" /></div>
          <div class="col-span-2 text-xs text-gray-500 mt-1">Tip: Use <span class="font-medium">Add Lesson â–¾</span> to add single lessons or generate a block of lessons.</div>
        </div>
      </div>
    </section>

    <!-- LESSONS TABLE -->
    <section class="mt-6 p-0">
      <div class="bg-white card border border-indigo-50 p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-gray-700">Lessons</h4>

          <!-- Add dropdown (Single / Block) -->
          <div class="relative inline-block text-left">
            <button id="add-menu-btn" onclick="toggleAddMenu()" class="btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-shadow shadow-sm">
              Add Lesson â–¾
            </button>
            <div id="add-menu" class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-40">
              <button onclick="openSingleLessonForm()" class="block w-full text-left px-4 py-3 hover:bg-indigo-50">âž• Single Lesson</button>
              <button onclick="openBlockBookingForm()" class="block w-full text-left px-4 py-3 hover:bg-indigo-50">ðŸ“… Block Booking</button>
            </div>
          </div>
        </div>

        <!-- single-lesson inline form -->
        <div id="single-lesson-form" class="no-print hidden mb-4 p-3 border border-gray-100 rounded-lg bg-indigo-50">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <select id="single-lesson-type" class="p-3 border rounded-lg"></select>
            <input id="single-lesson-date" type="date" class="p-3 border rounded-lg" />
            <input id="single-lesson-time" type="time" class="p-3 border rounded-lg" />
          </div>
          <div class="mt-3 flex gap-2">
            <button onclick="addSingleLessonFromForm()" class="btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add</button>
            <button onclick="closeSingleForm()" class="btn px-4 py-2 border rounded-lg">Cancel</button>
          </div>
        </div>

        <!-- block booking inline form -->
        <div id="block-booking-form" class="no-print hidden mb-4 p-3 border border-gray-100 rounded-lg bg-indigo-50">
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
            <select id="block-lesson-type" class="p-3 border rounded-lg"></select>
            <input id="block-start-date" type="date" class="p-3 border rounded-lg" />
            <input id="block-time" type="time" class="p-3 border rounded-lg" />
            <input id="block-weeks" type="number" min="1" value="4" class="p-3 border rounded-lg" placeholder="Number of weeks" />
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="text-sm text-gray-600">Creates one lesson per week (7 days apart). You can edit individual rows after generation.</div>
            <div class="flex gap-2">
              <button onclick="generateBlockLessons()" class="btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Generate Block</button>
              <button onclick="closeBlockForm()" class="btn px-4 py-2 border rounded-lg">Cancel</button>
            </div>
          </div>
        </div>

        <!-- table wrap for horizontal scroll on mobile -->
        <div class="table-wrap">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-indigo-700 text-white">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Description</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Date</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Time</th>
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase">Qty</th>
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase">Unit (Â£)</th>
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase">Amount (Â£)</th>
                <th class="px-2 py-3 no-print"></th>
              </tr>
            </thead>
            <tbody id="item-list" class="bg-white divide-y divide-gray-100">
              <!-- Rows inserted by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TOTALS card -->
    <section class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-white card border border-indigo-50">
        <h3 class="font-semibold text-gray-700 mb-2">Notes</h3>
        <textarea id="invoice-notes" rows="4" class="w-full p-3 border border-gray-200 rounded-lg" placeholder="e.g., Payment due upon receipt. Next lesson booked for..."></textarea>
      </div>

      <div class="p-4 bg-white card border border-indigo-50 flex flex-col justify-between">
        <div>
          <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Subtotal:</span>
            <span id="subtotal" class="font-medium">Â£0.00</span>
          </div>

          <div class="flex justify-between items-center text-sm text-gray-700 border-t pt-3">
            <div>
              <div id="travel-fee-label" class="font-medium">Travel Fee:</div>
              <div class="text-xs text-gray-500">Per session (multiplied by number of lessons)</div>
            </div>
            <div class="text-right">
              <select id="travel-fee" onchange="calculateTotal()" class="p-2 border rounded-lg">
                <option value="0">Within 5 miles â€“ Â£0</option>
                <option value="5">5 miles+ â€“ Â£5</option>
                <option value="10">10 miles+ â€“ Â£10</option>
                <option value="20">15 miles+ â€“ Â£20</option>
              </select>
              <div id="travel-fee-total" class="text-sm mt-2 text-gray-700">Â£0.00</div>
            </div>
          </div>
        </div>

        <div class="mt-4 border-t pt-4">
          <div class="flex justify-between items-center text-lg font-bold text-indigo-700">
            <span>GRAND TOTAL:</span>
            <span id="grand-total">Â£0.00</span>
          </div>

          <div class="mt-4 no-print">
            <button onclick="triggerPrint()" class="w-full btn px-4 py-3 bg-indigo-700 text-white rounded-lg hover:bg-indigo-800">Print / Save as PDF</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAYMENT details (card) -->
    <section class="mt-6">
      <div class="p-4 bg-white card border border-indigo-50">
        <h3 class="font-semibold text-gray-700 mb-2">Payment Details (Bank Transfer)</h3>
        <p class="text-gray-800 font-medium">Account Name: Elliot Wardill</p>
        <p class="text-gray-800 font-medium">Sort Code: 56-00-36</p>
        <p class="text-gray-800 font-medium">Account No: 40013987</p>
      </div>
    </section>

  </div>
</div>

<script>
  /******************************
   * Configuration & constants
   ******************************/
  const LESSON_OPTIONS = {
    'Standard Lesson (30 Mins)': 15.00,
    'Standard Lesson (60 Mins)': 30.00,
    'Standard Lesson (120 Mins)': 50.00,
    'Introductory Lesson': 10.00,
    'Free Taster Session': 0.00
  };

  /******************************
   * Helpers (date/time formatting)
   ******************************/
  function formatDateShortForDisplay(d) {
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yy = d.getFullYear();
    return dd + '/' + mm + '/' + yy;
  }

  function weekdayShort(d) {
    return d.toLocaleDateString('en-GB', { weekday: 'short' });
  }

  function formatTimeTo12H(timeStr) {
    if (!timeStr) return '';
    const [h, m] = timeStr.split(':').map(Number);
    const date = new Date();
    date.setHours(h, m);
    return date.toLocaleTimeString('en-GB', { hour: 'numeric', minute: '2-digit' });
  }

  // sanitize but allow slashes as requested
  function sanitizeFilenameAllowSlashes(str) {
    return str.replace(/[^a-z0-9 \\-_,.()\\/]/gi, '').trim();
  }

  /******************************
   * UI: Add menu toggles & forms
   ******************************/
  function toggleAddMenu() {
    const menu = document.getElementById('add-menu');
    menu.classList.toggle('hidden');
  }

  function openSingleLessonForm() {
    document.getElementById('add-menu').classList.add('hidden');
    document.getElementById('single-lesson-form').classList.remove('hidden');
    // set a smart default date = tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const iso = tomorrow.toISOString().split('T')[0];
    if (!document.getElementById('single-lesson-date').value) document.getElementById('single-lesson-date').value = iso;
  }
  function closeSingleForm() { document.getElementById('single-lesson-form').classList.add('hidden'); }

  function openBlockBookingForm() {
    document.getElementById('add-menu').classList.add('hidden');
    document.getElementById('block-booking-form').classList.remove('hidden');
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
    if (!document.getElementById('block-start-date').value) document.getElementById('block-start-date').value = tomorrow.toISOString().split('T')[0];
  }
  function closeBlockForm() { document.getElementById('block-booking-form').classList.add('hidden'); }

  /******************************
   * Row creation and behavior
   ******************************/
  function createRow({ lessonName, dateISO, timeStr, qty = 1, unitPrice = 0.00 }) {
    const tbody = document.getElementById('item-list');

    // create row
    const tr = document.createElement('tr');
    tr.className = 'item-row';

    // description cell
    const descCell = document.createElement('td');
    descCell.className = 'px-4 py-3 align-top';
    const descDiv = document.createElement('div');
    descDiv.className = 'desc-text text-gray-800 font-medium';
    updateRowDescriptionText(descDiv, lessonName, dateISO, timeStr);
    descCell.appendChild(descDiv);

    // date cell
    const dateCell = document.createElement('td');
    dateCell.className = 'px-4 py-3 align-top';
    const dateInput = document.createElement('input');
    dateInput.type = 'date';
    dateInput.value = dateISO || '';
    dateInput.className = 'p-2 border rounded-lg';
    dateCell.appendChild(dateInput);

    // time cell
    const timeCell = document.createElement('td');
    timeCell.className = 'px-4 py-3 align-top';
    const timeInput = document.createElement('input');
    timeInput.type = 'time';
    timeInput.value = timeStr || '';
    timeInput.className = 'p-2 border rounded-lg';
    timeCell.appendChild(timeInput);

    // qty
    const qtyCell = document.createElement('td');
    qtyCell.className = 'px-4 py-3 align-top text-right';
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '1';
    qtyInput.value = qty;
    qtyInput.className = 'item-qty w-20 p-2 text-right border-b border-gray-200';
    qtyCell.appendChild(qtyInput);

    // unit price
    const priceCell = document.createElement('td');
    priceCell.className = 'px-4 py-3 align-top text-right';
    const priceInput = document.createElement('input');
    priceInput.type = 'number';
    priceInput.min = '0';
    priceInput.step = '0.01';
    priceInput.value = parseFloat(unitPrice).toFixed(2);
    priceInput.className = 'item-price w-24 p-2 text-right border-b border-gray-200';
    priceCell.appendChild(priceInput);

    // amount
    const amountCell = document.createElement('td');
    amountCell.className = 'px-4 py-3 align-top text-right font-medium';
    amountCell.textContent = (qty * unitPrice).toFixed(2);

    // remove
    const rmCell = document.createElement('td');
    rmCell.className = 'px-2 py-3 no-print';
    const rmBtn = document.createElement('button');
    rmBtn.className = 'text-red-500 hover:text-red-700';
    rmBtn.innerHTML = 'âœ•';
    rmBtn.onclick = () => { tr.remove(); calculateTotal(); };
    rmCell.appendChild(rmBtn);

    // append
    tr.appendChild(descCell);
    tr.appendChild(dateCell);
    tr.appendChild(timeCell);
    tr.appendChild(qtyCell);
    tr.appendChild(priceCell);
    tr.appendChild(amountCell);
    tr.appendChild(rmCell);
    tbody.appendChild(tr);

    // events to keep in sync
    dateInput.addEventListener('input', () => { updateRowDescriptionText(descDiv, lessonName, dateInput.value, timeInput.value); calculateTotal(); });
    timeInput.addEventListener('input', () => { updateRowDescriptionText(descDiv, lessonName, dateInput.value, timeInput.value); calculateTotal(); });
    qtyInput.addEventListener('input', () => { amountCell.textContent = (parseFloat(qtyInput.value||0) * parseFloat(priceInput.value||0)).toFixed(2); calculateTotal(); });
    priceInput.addEventListener('input', () => { amountCell.textContent = (parseFloat(qtyInput.value||0) * parseFloat(priceInput.value||0)).toFixed(2); calculateTotal(); });

    calculateTotal();
    return tr;
  }

  function updateRowDescriptionText(descElement, lessonName, dateISO, timeStr) {
    const parts = [lessonName];
    if (dateISO) {
      try {
        const d = new Date(dateISO + 'T00:00:00');
        const weekday = weekdayShort(d);
        const dateStr = formatDateShortForDisplay(d);
        if (timeStr) {
          const timeFormatted = formatTimeTo12H(timeStr);
          parts.push(`${weekday} ${timeFormatted} â€“ ${dateStr}`);
        } else {
          parts.push(`${weekday} â€“ ${dateStr}`);
        }
      } catch (e) {
        parts.push(dateISO);
      }
    } else if (timeStr) {
      parts.push(formatTimeTo12H(timeStr));
    }
    descElement.textContent = parts.join(' â€“ ');
  }

  /******************************
   * Add single/block actions
   ******************************/
  function addSingleLesson(lessonName, dateISO, timeStr) {
    const price = LESSON_OPTIONS[lessonName] ?? 0.00;
    createRow({ lessonName, dateISO, timeStr, qty: 1, unitPrice: price });
  }

  function addSingleLessonFromForm() {
    const lesson = document.getElementById('single-lesson-type').value;
    const date = document.getElementById('single-lesson-date').value;
    const time = document.getElementById('single-lesson-time').value;
    if (!lesson) { alert('Please select a lesson type'); return; }
    addSingleLesson(lesson, date, time);
    closeSingleForm();
  }

  function generateBlockLessons() {
    const lesson = document.getElementById('block-lesson-type').value;
    const startDateISO = document.getElementById('block-start-date').value;
    const time = document.getElementById('block-time').value;
    const weeks = parseInt(document.getElementById('block-weeks').value) || 0;

    if (!lesson) { alert('Choose a lesson type'); return; }
    if (!startDateISO) { alert('Choose a start date'); return; }
    if (!weeks || weeks < 1) { alert('Enter number of weeks (>=1)'); return; }

    const startDate = new Date(startDateISO + 'T00:00:00');
    for (let i = 0; i < weeks; i++) {
      const d = new Date(startDate);
      d.setDate(startDate.getDate() + (i * 7));
      const iso = d.toISOString().split('T')[0];
      addSingleLesson(lesson, iso, time);
    }

    closeBlockForm();
  }

  /******************************
   * Totals & travel-per-session
   ******************************/
  function calculateTotal() {
    let subtotal = 0;
    const rows = document.querySelectorAll('#item-list tr');
    rows.forEach(tr => {
      const qty = parseFloat(tr.querySelector('.item-qty').value) || 0;
      const price = parseFloat(tr.querySelector('.item-price').value) || 0;
      const amount = qty * price;
      const amountCell = tr.querySelector('td:nth-child(6)');
      if (amountCell) amountCell.textContent = amount.toFixed(2);
      subtotal += amount;
    });

    const lessonCount = rows.length;
    const travelPerSession = parseFloat(document.getElementById('travel-fee').value) || 0;
    const totalTravel = travelPerSession * lessonCount;

    // Update labels & totals display
    const travelLabel = document.getElementById('travel-fee-label');
    travelLabel.textContent = `Travel Fee (x${lessonCount} sessions):`;

    document.getElementById('travel-fee-total').textContent = 'Â£' + totalTravel.toFixed(2);

    const grand = subtotal + totalTravel;
    document.getElementById('subtotal').textContent = 'Â£' + subtotal.toFixed(2);
    document.getElementById('grand-total').textContent = 'Â£' + grand.toFixed(2);
  }

  /******************************
   * Filename helper (earliest lesson date)
   ******************************/
  function getEarliestLessonDateForFilename() {
    const dateInputs = Array.from(document.querySelectorAll('#item-list input[type="date"]'))
      .map(i => i.value)
      .filter(v => v && v.trim().length > 0);

    if (dateInputs.length === 0) return null;
    const timestamps = dateInputs.map(s => new Date(s + 'T00:00:00').getTime());
    const minTs = Math.min(...timestamps);
    const d = new Date(minTs);
    return formatDateShortForDisplay(d); // dd/mm/yyyy
  }

  function prepareForPrint() {
    const invoiceNo = document.getElementById('invoice-number').value || 'Invoice';
    const client = document.getElementById('client-name').value || 'Client';
    const earliest = getEarliestLessonDateForFilename();
    const fileDate = earliest ? earliest : formatDateShortForDisplay(new Date());
    const filename = `${client} - ${fileDate} - ${invoiceNo}`;
    document.title = sanitizeFilenameAllowSlashes(filename);

    // Ensure descriptions reflect latest date/time
    document.querySelectorAll('#item-list tr').forEach(tr => {
      const descEl = tr.querySelector('.desc-text');
      const lessonName = descEl ? descEl.textContent.split(' â€“ ')[0] : '';
      const date = tr.querySelector('input[type="date"]').value;
      const time = tr.querySelector('input[type="time"]').value;
      if (descEl) updateRowDescriptionText(descEl, lessonName, date, time);
    });
  }

  function triggerPrint() {
    prepareForPrint();
    window.print();
    setTimeout(() => { document.title = 'Elliot Wardill Invoice Generator'; }, 1000);
  }

  /******************************
   * Initialization
   ******************************/
  function populateLessonSelects() {
    const blockSelect = document.getElementById('block-lesson-type');
    const singleSelect = document.getElementById('single-lesson-type');
    blockSelect.innerHTML = '';
    singleSelect.innerHTML = '';

    const placeholder = document.createElement('option');
    placeholder.disabled = true;
    placeholder.selected = true;
    placeholder.textContent = 'Select Lesson Type';
    singleSelect.appendChild(placeholder.cloneNode(true));
    blockSelect.appendChild(placeholder.cloneNode(true));

    Object.keys(LESSON_OPTIONS).forEach(name => {
      const o1 = document.createElement('option');
      o1.value = name;
      o1.textContent = name;
      singleSelect.appendChild(o1);

      const o2 = document.createElement('option');
      o2.value = name;
      o2.textContent = name;
      blockSelect.appendChild(o2);
    });
  }

  window.onload = function() {
    const todayISO = new Date().toISOString().split('T')[0];
    document.getElementById('due-date').value = todayISO;
    document.getElementById('invoice-date').textContent = new Date().toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('invoice-number').value = 'EW-' + Math.floor(Math.random()*90000 + 10000);

    populateLessonSelects();

    // convenience: add one default row
    addSingleLesson('Standard Lesson (60 Mins)', todayISO, '17:00');

    // Hide add menu when clicking outside
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('add-menu');
      const btn = document.getElementById('add-menu-btn');
      if (!btn.contains(e.target) && menu && !menu.contains(e.target)) menu.classList.add('hidden');
    });

    // Recalculate totals when editing rows directly
    document.getElementById('item-list').addEventListener('input', function() {
      calculateTotal();
    });
  };
</script>
</body>
</html>
