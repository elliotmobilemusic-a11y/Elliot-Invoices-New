<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elliot’s Mobile Music — Invoice Maker</title>
  <link rel="icon" type="image/png" href="i-favicon.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4f46e5" />

  <style>
    /* (Same layout + mobile polish like your current file) */
    @media (max-width: 768px) {
      body { padding: 0; margin: 0; background: #ffffff; }
      .invoice-container { width: 100%; max-width: 100% !important; margin: 0 !important; border-radius: 0 !important; padding: 1rem !important; box-shadow: none !important; border: none !important; }
      header { flex-direction: column; text-align: center; gap: 1rem; }
      .grid-cols-2 { grid-template-columns: 1fr !important; }
      table { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-spacing: 0; }
      th, td { white-space: nowrap; padding: 0.5rem !important; }
      #add-item-btn { width: 100%; justify-content: center; }
      #add-menu { width: 100% !important; left: 0 !important; right: 0 !important; }
      .md\:w-1\/2 { width: 100% !important; }
      .no-print button { width: 100%; }
    }

    @media (max-width: 430px) {
      h1, h2, h3 { font-size: 90%; }
      input, select, textarea { font-size: 14px !important; }
      #invoice-number { width: 110px !important; }
    }

    @media print {
      body { background: white; font-size: 10pt; }
      .no-print { display: none !important; }
      .invoice-container { box-shadow: none !important; border: none !important; margin: 0; padding: 0; }
      .text-gray-700, .text-gray-900 { color: #000 !important; }
      input, select, textarea { border: none !important; background: transparent !important; box-shadow: none !important; }
      input[type="date"], input[type="time"] { border: none !important; background: transparent !important; }

      #receipt-document, #invoice-document { display: none !important; }
      body[data-print-mode="invoice"] #invoice-document { display: block !important; }
      body[data-print-mode="receipt"] #receipt-document { display: block !important; }
    }

    body { font-family: "Inter", sans-serif; background-color: #f7f9fb; }
    .invoice-container {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 0px 10px -5px rgba(0,0,0,0.04);
      padding: 2.5rem;
      border: 1px solid #e5e7eb;
      position: relative;
    }

    .paid-stamp {
      position: absolute;
      top: 96px;
      right: 28px;
      transform: rotate(12deg);
      border: 4px solid rgba(16, 185, 129, 0.85);
      color: rgba(16, 185, 129, 0.9);
      padding: 8px 14px;
      border-radius: 10px;
      font-weight: 900;
      letter-spacing: 2px;
      font-size: 22px;
      display: none;
      pointer-events: none;
      background: rgba(16, 185, 129, 0.06);
    }
    .paid-stamp.show { display: block; }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(17, 24, 39, 0.95);
      color: white;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      z-index: 9999;
      display: none;
      max-width: calc(100% - 24px);
    }
    .toast.show { display: block; }
  </style>
</head>

<body data-print-mode="invoice">
  <div id="toast" class="toast"></div>

  <!-- =======================
       INVOICE DOCUMENT
  ======================== -->
  <div class="invoice-container" id="invoice-document">
    <div id="paid-stamp" class="paid-stamp">PAID</div>

    <!-- Header -->
    <header class="flex justify-between items-center pb-6 border-b border-indigo-200">
      <div>
        <h1 class="text-3xl font-extrabold text-indigo-700">INVOICE</h1>
        <div class="mt-2 flex items-center space-x-2 text-sm text-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span id="invoice-date"></span>
        </div>
      </div>

      <div class="text-right">
        <h2 class="text-xl font-semibold text-gray-900">Elliot’s Mobile Music</h2>
        <p class="text-sm text-gray-500">Pudsey, UK</p>
        <p class="text-sm text-gray-500">Email: elliotmobilemusic@gmail.com</p>
        <p class="text-sm text-gray-500">Phone: 07368 975144</p>
      </div>
    </header>

    <!-- Cloud controls -->
    <section class="no-print pt-6 pb-4 border-b border-gray-100 flex flex-col md:flex-row md:items-end gap-3 md:justify-between">
      <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
        <button id="btn-save-cloud" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Save to Cloud
        </button>
        <button id="btn-refresh" class="px-4 py-2 bg-gray-100 text-gray-900 rounded-lg hover:bg-gray-200">
          Refresh Lists
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 w-full md:w-[520px]">
        <div>
          <label class="text-xs text-gray-600">Load Customer</label>
          <select id="customer-picker" class="w-full p-2 border border-gray-300 rounded-lg">
            <option value="">—</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-600">Load Invoice</label>
          <select id="invoice-picker" class="w-full p-2 border border-gray-300 rounded-lg">
            <option value="">—</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Client + Invoice Info -->
    <section class="py-6 border-b border-gray-100 grid grid-cols-2 gap-4 text-sm">
      <div>
        <h3 class="font-semibold text-gray-700 mb-2">BILL TO:</h3>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
          <div class="sm:col-span-2">
            <input id="client-name" type="text" placeholder="Client Name" class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div class="sm:col-span-2">
            <input id="client-address" type="text" placeholder="Address, Postcode" class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div class="sm:col-span-2">
            <input id="client-email" type="email" placeholder="Client Email (receipt sends automatically)" class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
        </div>

        <div class="no-print">
          <button id="btn-save-customer" class="px-3 py-2 bg-gray-100 text-gray-900 rounded-lg hover:bg-gray-200">
            Save Customer
          </button>
        </div>
      </div>

      <div class="text-right">
        <div class="flex flex-col items-end gap-2">
          <div class="w-full sm:w-auto">
            <h3 class="font-semibold text-gray-700 mb-2">INVOICE NO:</h3>
            <input id="invoice-number" type="text" class="w-40 p-2 border border-gray-300 rounded-lg text-right" />
          </div>

          <div class="w-full sm:w-auto">
            <div class="text-gray-500">
              DUE DATE:
              <input id="due-date" type="date" class="border border-gray-300 rounded-lg p-1 ml-2" />
            </div>
          </div>

          <div class="w-full sm:w-auto">
            <label class="text-xs text-gray-500">Programme</label>
            <select id="programme" class="w-56 p-2 border border-gray-300 rounded-lg text-right">
              <option value="lessons">Lessons</option>
              <option value="school_band">School Band Programme</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Items Table -->
    <section class="mt-8">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Qty</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Unit (£)</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount (£)</th>
            <th class="px-2 py-3 no-print"></th>
          </tr>
        </thead>
        <tbody id="item-list" class="bg-white divide-y divide-gray-200"></tbody>
      </table>

      <!-- Add Menu -->
      <div class="no-print mt-4">
        <div class="inline-block text-left relative w-full sm:w-auto">
          <button id="add-item-btn" type="button"
            class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 flex items-center"
            aria-haspopup="true" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            Add Item
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <div id="add-menu" class="origin-top-left absolute left-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10 p-3">
            <button id="btn-add-single" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100">➕ Add Single Lesson</button>
            <hr class="my-2">

            <div class="text-sm">
              <label class="font-semibold">Block of Lessons</label>
              <p class="text-xs text-gray-500 mb-2">Create multiple weekly lessons automatically.</p>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs">Start Date</label>
                  <input id="block-start-date" type="date" class="w-full p-1 border border-gray-300 rounded text-sm">
                </div>
                <div>
                  <label class="text-xs">Start Time</label>
                  <input id="block-start-time" type="time" class="w-full p-1 border border-gray-300 rounded text-sm">
                </div>
                <div>
                  <label class="text-xs">Weeks</label>
                  <input id="block-weeks" type="number" min="1" value="4" class="w-full p-1 border border-gray-300 rounded text-sm">
                </div>
                <div>
                  <label class="text-xs">Lesson Type</label>
                  <select id="block-lesson-type" class="w-full p-1 border border-gray-300 rounded text-sm"></select>
                </div>
              </div>

              <div class="mt-2 text-xs text-gray-700">
                <div>Last lesson date: <span id="block-end-date">—</span></div>
              </div>

              <button id="btn-generate-block" class="mt-3 w-full px-3 py-2 bg-indigo-100 text-indigo-800 rounded hover:bg-indigo-200">
                Generate Block
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Totals -->
    <section class="mt-8 flex justify-end">
      <div class="w-full md:w-1/2">
        <div class="flex justify-between text-sm text-gray-700 border-b pb-2">
          <span>SUBTOTAL:</span>
          <span id="subtotal">£0.00</span>
        </div>

        <div class="flex justify-between text-sm text-gray-700 border-b py-2 items-center">
          <span>TRAVEL FEE:</span>
          <input id="travel-fee" type="number" value="0" min="0" step="0.01" class="w-28 p-1 text-right border border-gray-300 rounded-lg" />
        </div>

        <div id="deposit-wrap" class="hidden">
          <div class="flex justify-between text-sm text-gray-700 border-b py-2 items-center">
            <span>STRIPE DEPOSIT PAID:</span>
            <input id="deposit-amount" type="number" value="10" min="0" step="0.01" class="w-28 p-1 text-right border border-gray-300 rounded-lg" />
          </div>
          <div class="text-xs text-gray-500 mt-1">
            Deposit reduces the balance due (total package stays the same).
          </div>
        </div>

        <div id="total-before-wrap" class="hidden">
          <div class="flex justify-between text-sm text-gray-700 border-b py-2">
            <span>TOTAL (PACKAGE):</span>
            <span id="total-before">£0.00</span>
          </div>
        </div>

        <div class="flex justify-between text-lg font-bold text-gray-800 pt-4 border-t-4 border-indigo-500">
          <span>GRAND TOTAL DUE:</span>
          <span id="grand-total" class="text-indigo-700">£0.00</span>
        </div>
      </div>
    </section>

    <!-- Notes -->
    <section class="mt-8">
      <h3 class="font-semibold text-gray-700 mb-2">Notes</h3>
      <textarea id="notes" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Additional notes..."></textarea>
    </section>

    <!-- Paid controls -->
    <section class="no-print mt-6 border-t pt-6">
      <h3 class="font-semibold text-gray-700 mb-2">Payment</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div>
          <label class="text-xs text-gray-500">Paid Date/Time</label>
          <input id="paid-datetime" type="datetime-local" class="w-full p-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="text-xs text-gray-500">Method</label>
          <select id="paid-method" class="w-full p-2 border border-gray-300 rounded-lg">
            <option>Bank Transfer</option>
            <option>Cash</option>
            <option>Card</option>
            <option>Stripe</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500">Reference (optional)</label>
          <input id="paid-ref" type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g. STRIPE-XXXX">
        </div>
      </div>

      <div class="mt-3 flex flex-col sm:flex-row gap-2">
        <button id="btn-mark-paid" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
          Mark as Paid (auto-email receipt)
        </button>
        <button id="btn-mark-unpaid" class="px-4 py-2 bg-gray-100 text-gray-900 rounded-lg hover:bg-gray-200">
          Mark as Unpaid
        </button>
        <button id="btn-email-receipt" class="px-4 py-2 bg-emerald-100 text-emerald-900 rounded-lg hover:bg-emerald-200">
          Send Receipt Again
        </button>
      </div>
    </section>

    <!-- Print buttons -->
    <section class="no-print mt-8 flex flex-col sm:flex-row gap-2">
      <button id="btn-print-invoice" class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Print Invoice</button>
      <button id="btn-print-receipt" class="px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Print Receipt</button>
    </section>
  </div>

  <!-- =======================
       RECEIPT DOCUMENT
  ======================== -->
  <div class="invoice-container" id="receipt-document">
    <header class="flex justify-between items-center pb-6 border-b border-emerald-200">
      <div>
        <h1 class="text-3xl font-extrabold text-emerald-700">RECEIPT</h1>
        <p class="mt-2 text-sm text-gray-600">Payment confirmation for your records.</p>
      </div>

      <div class="text-right">
        <h2 class="text-xl font-semibold text-gray-900">Elliot’s Mobile Music</h2>
        <p class="text-sm text-gray-600">Pudsey, UK</p>
        <p class="text-sm text-gray-600">Email: elliotmobilemusic@gmail.com</p>
        <p class="text-sm text-gray-600">Phone: 07368 975144</p>
      </div>
    </header>

    <section class="py-6 grid grid-cols-2 gap-4 text-sm border-b border-gray-100">
      <div>
        <h3 class="font-semibold text-gray-700 mb-2">RECEIPT TO:</h3>
        <div class="text-gray-900 font-semibold" id="r-client-name">—</div>
        <div class="text-gray-700" id="r-client-address">—</div>
        <div class="text-gray-700" id="r-client-email">—</div>
      </div>

      <div class="text-right">
        <div class="text-gray-700">Receipt No: <span class="font-semibold text-gray-900" id="r-receipt-no">—</span></div>
        <div class="text-gray-700 mt-1">Invoice No: <span class="font-semibold text-gray-900" id="r-invoice-no">—</span></div>
        <div class="text-gray-700 mt-1">Paid Date: <span class="font-semibold text-gray-900" id="r-paid-date">—</span></div>
        <div class="text-gray-700 mt-1">Method: <span class="font-semibold text-gray-900" id="r-method">—</span></div>
        <div class="text-gray-700 mt-1">Ref: <span class="font-semibold text-gray-900" id="r-ref">—</span></div>
      </div>
    </section>

    <section class="mt-6">
      <h3 class="font-semibold text-gray-700 mb-2">Items Paid</h3>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-emerald-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Qty</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Unit (£)</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount (£)</th>
          </tr>
        </thead>
        <tbody id="r-item-list" class="bg-white divide-y divide-gray-200"></tbody>
      </table>

      <div class="mt-6 flex justify-end">
        <div class="w-full md:w-1/2">
          <div id="r-breakdown" class="text-sm text-gray-700 space-y-2"></div>
          <div class="flex justify-between text-lg font-bold text-gray-800 pt-4 border-t-4 border-emerald-500">
            <span>TOTAL PAID:</span>
            <span id="r-total" class="text-emerald-700">£0.00</span>
          </div>
        </div>
      </div>

      <p class="mt-6 text-sm text-gray-700">
        Thank you — your payment has been received.
      </p>
    </section>
  </div>

  <script>
    // Service worker (avoid caching /api)
    document.addEventListener("DOMContentLoaded", () => {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").catch(() => {});
      }
    });

    /* ==========================
       CONFIG
    ========================== */
    const BAND_TERM_FULL_PRICE = 90.00;   // 6 weeks term
    const STRIPE_DEPOSIT = 10.00;         // deposit paid via Stripe
    const LESSON_OPTIONS = {
      "Standard Lesson (30 Mins)": 15.00,
      "Standard Lesson (60 Mins)": 30.00,
      "Standard Lesson (120 Mins)": 50.00,
      "Introductory Lesson": 10.00,
      "Free Taster Session": 0.00,
      "Cancellation Fee (24 Hour Policy)": 0.00,

      // School band (matches your programme docs)
      "School Band Programme (Per session, per child)": 15.00,
      "School Band Programme (Term block – 6 weeks, per child) — full price (£90)": BAND_TERM_FULL_PRICE,

      "Custom Item": 0.00
    };

    const $ = (id) => document.getElementById(id);
    const STORAGE_KEY = "emm_invoice_cloud_v1";
    let autosaveTimer = null;
    let currentInvoiceId = null;

    function fmtGBP(n) {
      const num = Number(n || 0);
      return `£${num.toFixed(2)}`;
    }

    function toast(msg) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2600);
    }

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function showAddMenu() {
      $("add-menu").classList.remove("hidden");
      $("add-item-btn").setAttribute("aria-expanded", "true");
    }
    function hideAddMenu() {
      $("add-menu").classList.add("hidden");
      $("add-item-btn").setAttribute("aria-expanded", "false");
    }
    function toggleAddMenu() {
      const isHidden = $("add-menu").classList.contains("hidden");
      if (isHidden) showAddMenu(); else hideAddMenu();
    }

    function populateBlockLessonTypes() {
      const sel = $("block-lesson-type");
      sel.innerHTML = "";
      Object.keys(LESSON_OPTIONS).forEach((name) => {
        // block generator is for lesson-type rows only; but keeping it broad is fine
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    }

    function updateBlockPreview() {
      const start = $("block-start-date").value;
      const weeks = parseInt($("block-weeks").value, 10) || 1;

      if (!start) { $("block-end-date").textContent = "—"; return; }
      const startDate = new Date(start);
      const lastDate = new Date(startDate);
      lastDate.setDate(startDate.getDate() + (weeks - 1) * 7);
      $("block-end-date").textContent = lastDate.toLocaleDateString("en-GB");
    }

    function generateBlock() {
      const start = $("block-start-date").value;
      const time = $("block-start-time").value;
      const weeks = parseInt($("block-weeks").value, 10) || 1;
      const lessonType = $("block-lesson-type").value || "Standard Lesson (60 Mins)";

      if (!start) { alert("Please choose a start date for the block of lessons."); return; }

      const startDate = new Date(start);
      for (let i = 0; i < weeks; i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i * 7);
        const iso = d.toISOString().split("T")[0];
        addItem(lessonType, iso, time);
      }
      hideAddMenu();
      calculateTotal();
      autosaveSoon();
    }

    function createLessonSelect(defaultOption) {
      let html = '<select class="lesson-select w-full p-1 border border-gray-300 rounded-lg text-sm">';
      html += '<option disabled>Select Lesson Type / Item</option>';
      for (const [name, price] of Object.entries(LESSON_OPTIONS)) {
        const selected = (name === defaultOption) ? "selected" : "";
        html += `<option value="${escapeHtml(name)}" data-price="${price}" ${selected}>${escapeHtml(name)}</option>`;
      }
      html += "</select>";
      return html;
    }

    function addItem(defaultOption = "Standard Lesson (60 Mins)", dateValue = "", timeValue = "", qtyValue = 1, priceOverride = null) {
      const list = $("item-list");
      const row = document.createElement("tr");
      row.className = "item-row";

      const basePrice = LESSON_OPTIONS[defaultOption] ?? 0;
      const price = (priceOverride !== null && priceOverride !== undefined) ? Number(priceOverride) : Number(basePrice);

      row.innerHTML = `
        <td class="px-6 py-4 text-sm text-gray-900">
          ${createLessonSelect(defaultOption)}
          <div class="mt-2 text-xs text-gray-600">
            <div class="flex items-center space-x-2">
              <input type="date" class="lesson-date p-1 border border-gray-200 rounded text-xs" value="${dateValue}">
              <input type="time" class="lesson-time p-1 border border-gray-200 rounded text-xs" value="${timeValue}">
            </div>
          </div>
        </td>

        <td class="px-6 py-4 text-right text-sm">
          <input type="number" value="${Number(qtyValue) || 1}" min="1"
            class="item-qty w-16 p-1 text-right border-b border-gray-300">
        </td>

        <td class="px-6 py-4 text-right text-sm">
          <input type="number" value="${Number(price).toFixed(2)}" min="-99999" step="0.01"
            class="item-price w-20 p-1 text-right border-b border-gray-300">
        </td>

        <td class="px-6 py-4 text-right text-sm font-medium total-amount">0.00</td>

        <td class="px-2 py-4 no-print">
          <button type="button" class="remove-row text-red-500 hover:text-red-700" aria-label="Remove item">✕</button>
        </td>
      `;

      list.appendChild(row);

      const sel = row.querySelector(".lesson-select");
      const qty = row.querySelector(".item-qty");
      const priceEl = row.querySelector(".item-price");
      const dateEl = row.querySelector(".lesson-date");
      const timeEl = row.querySelector(".lesson-time");
      const removeBtn = row.querySelector(".remove-row");

      sel.addEventListener("change", () => {
        const label = sel.value || "";
        const p = Number(sel.selectedOptions[0].dataset.price || 0);
        priceEl.value = p.toFixed(2);

        // Auto switch programme + deposit defaults if band item chosen
        if (label.startsWith("School Band Programme")) {
          $("programme").value = "school_band";
          syncProgrammeUI(true);
        }

        calculateTotal();
        autosaveSoon();
      });

      [qty, priceEl, dateEl, timeEl].forEach(el => {
        el.addEventListener("input", () => { calculateTotal(); autosaveSoon(); });
        el.addEventListener("change", () => { calculateTotal(); autosaveSoon(); });
      });

      removeBtn.addEventListener("click", () => {
        row.remove();
        calculateTotal();
        autosaveSoon();
      });

      calculateTotal();
      autosaveSoon();
    }

    function calculateTotal() {
      let subtotal = 0;

      document.querySelectorAll(".item-row").forEach(row => {
        const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
        const price = parseFloat(row.querySelector(".item-price").value) || 0;

        const total = qty * price;
        row.querySelector(".total-amount").textContent = total.toFixed(2);
        subtotal += total;
      });

      const travelFee = parseFloat($("travel-fee").value) || 0;
      const totalPackage = subtotal + travelFee;

      const programme = $("programme").value;
      const deposit = programme === "school_band" ? (parseFloat($("deposit-amount").value) || 0) : 0;
      const balanceDue = Math.max(0, totalPackage - deposit);

      $("subtotal").textContent = fmtGBP(subtotal);

      // If deposit used, show the package total and due total separately
      if (programme === "school_band" && deposit > 0) {
        $("total-before-wrap").classList.remove("hidden");
        $("total-before").textContent = fmtGBP(totalPackage);
      } else {
        $("total-before-wrap").classList.add("hidden");
      }

      $("grand-total").textContent = fmtGBP(balanceDue);

      // Keep receipt preview in sync if needed
      if ($("paid-stamp").classList.contains("show")) {
        populateReceiptDocument();
      }
    }

    function getItems() {
      const items = [];
      document.querySelectorAll(".item-row").forEach(row => {
        const desc = row.querySelector(".lesson-select").value || "";
        const date = row.querySelector(".lesson-date").value || "";
        const time = row.querySelector(".lesson-time").value || "";
        const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
        const unit = parseFloat(row.querySelector(".item-price").value) || 0;
        const amount = qty * unit;
        items.push({ desc, date, time, qty, unit, amount });
      });
      return items;
    }

    function getTotals() {
      let subtotal = 0;
      getItems().forEach(it => subtotal += Number(it.amount || 0));
      const travel_fee = Number(parseFloat($("travel-fee").value) || 0);
      const total = subtotal + travel_fee;

      const programme = $("programme").value;
      const deposit_amount = programme === "school_band" ? Number(parseFloat($("deposit-amount").value) || 0) : 0;
      return { subtotal, travel_fee, total, deposit_amount };
    }

    function getCustomer() {
      return {
        name: ($("client-name").value || "").trim(),
        email: ($("client-email").value || "").trim(),
        address: ($("client-address").value || "").trim(),
        phone: ""
      };
    }

    function getPaidPayload() {
      const dt = $("paid-datetime").value;
      // Convert "yyyy-mm-ddThh:mm" to ISO if present (local time)
      const paid_at = dt ? new Date(dt).toISOString() : new Date().toISOString();
      return {
        paid_at,
        paid_method: $("paid-method").value || "Bank Transfer",
        paid_ref: ($("paid-ref").value || "").trim()
      };
    }

    function syncProgrammeUI(userChanged = false) {
      const programme = $("programme").value;
      if (programme === "school_band") {
        $("deposit-wrap").classList.remove("hidden");
        if (userChanged && (!$("deposit-amount").value || Number($("deposit-amount").value) === 0)) {
          $("deposit-amount").value = STRIPE_DEPOSIT.toFixed(2);
        }
      } else {
        $("deposit-wrap").classList.add("hidden");
        $("deposit-amount").value = "0";
      }
      calculateTotal();
    }

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        ...opts,
        headers: { "Content-Type": "application/json", ...(opts.headers || {}) }
      });
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch { data = { ok: false, raw: text }; }
      if (!res.ok || !data.ok) {
        const msg = data?.error || data?.message || `Request failed (${res.status})`;
        throw new Error(msg);
      }
      return data;
    }

    async function refreshLists() {
      const c = await api("/api/customers?limit=50");
      const customerPicker = $("customer-picker");
      customerPicker.innerHTML = '<option value="">—</option>';
      c.customers.forEach(x => {
        const opt = document.createElement("option");
        opt.value = String(x.id);
        opt.textContent = `${x.name}${x.email ? " — " + x.email : ""}`;
        opt.dataset.email = x.email || "";
        opt.dataset.address = x.address || "";
        customerPicker.appendChild(opt);
      });

      const inv = await api("/api/invoices?limit=50");
      const invoicePicker = $("invoice-picker");
      invoicePicker.innerHTML = '<option value="">—</option>';
      inv.invoices.forEach(x => {
        const opt = document.createElement("option");
        opt.value = String(x.id);
        const paid = x.paid_at ? "✅" : "—";
        opt.textContent = `${paid} ${x.invoice_no} — ${x.customer_name || ""} — ${fmtGBP(x.total)}${x.deposit_amount ? " (dep " + fmtGBP(x.deposit_amount) + ")" : ""}`;
        invoicePicker.appendChild(opt);
      });

      toast("Lists refreshed");
    }

    async function saveCustomerToCloud() {
      // Customer is saved when invoice is saved; this button is just a convenience
      const customer = getCustomer();
      if (!customer.name) { alert("Customer name is required"); return; }
      // Save a tiny “draft invoice” to upsert customer cleanly
      await saveInvoiceToCloud(true);
      toast("Customer saved");
      await refreshLists();
    }

    async function saveInvoiceToCloud(silent = false) {
      const customer = getCustomer();
      if (!customer.name) { alert("Customer name is required"); return; }

      const invoice_no = ($("invoice-number").value || "").trim();
      if (!invoice_no) { alert("Invoice number is required"); return; }

      const programme = $("programme").value;

      const items = getItems();
      const { subtotal, travel_fee, total, deposit_amount } = getTotals();

      const payload = {
        invoice_no,
        programme,
        due_date: $("due-date").value || null,
        notes: ($("notes").value || "").trim(),
        subtotal,
        travel_fee,
        total,
        deposit_amount,
        customer,
        items
      };

      const data = await api("/api/invoices", { method: "POST", body: JSON.stringify(payload) });
      currentInvoiceId = data.id;
      localStorage.setItem("emm_current_invoice_id", String(currentInvoiceId || ""));
      if (!silent) toast("Saved to cloud");
      return data;
    }

    async function loadInvoiceFromCloud(id) {
      const data = await api(`/api/invoices/${id}`);
      const inv = data.invoice;

      currentInvoiceId = inv.id;
      localStorage.setItem("emm_current_invoice_id", String(inv.id));

      $("client-name").value = inv.customer?.name || "";
      $("client-email").value = inv.customer?.email || "";
      $("client-address").value = inv.customer?.address || "";

      $("invoice-number").value = inv.invoice_no || "";
      $("due-date").value = inv.due_date || "";

      $("programme").value = inv.programme || "lessons";
      syncProgrammeUI(false);

      $("travel-fee").value = Number(inv.travel_fee || 0).toFixed(2);
      $("deposit-amount").value = Number(inv.deposit_amount || 0).toFixed(2);

      $("notes").value = inv.notes || "";

      // items
      $("item-list").innerHTML = "";
      (inv.items || []).forEach(it => {
        addItem(it.desc || "Standard Lesson (60 Mins)", it.date || "", it.time || "", it.qty || 1, it.unit);
      });
      if ((inv.items || []).length === 0) addItem();

      // Paid state
      const isPaid = !!inv.paid_at;
      $("paid-stamp").classList.toggle("show", isPaid);

      if (isPaid) {
        // populate paid fields
        const d = new Date(inv.paid_at);
        // Set datetime-local value (local)
        const pad = (n) => String(n).padStart(2, "0");
        const localValue = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        $("paid-datetime").value = localValue;
        $("paid-method").value = inv.paid_method || "Bank Transfer";
        $("paid-ref").value = inv.paid_ref || "";
      }

      calculateTotal();
      populateReceiptDocument(inv);

      toast("Invoice loaded");
    }

    function populateReceiptDocument(dbInvoice = null) {
      // Use UI values (or dbInvoice when available)
      const customer = getCustomer();
      const items = getItems();
      const { travel_fee, total, deposit_amount } = getTotals();
      const programme = $("programme").value;

      $("r-client-name").textContent = customer.name || "—";
      $("r-client-address").textContent = customer.address || "—";
      $("r-client-email").textContent = customer.email || "—";

      const invNo = ($("invoice-number").value || "").trim();
      $("r-invoice-no").textContent = invNo || "—";

      // Receipt number if DB already has one
      const receiptNo = dbInvoice?.receipt_no || (invNo ? `RCPT-${invNo}` : "—");
      $("r-receipt-no").textContent = receiptNo || "—";

      // Paid info from DB if present
      const paidAt = dbInvoice?.paid_at || null;
      const paidMethod = dbInvoice?.paid_method || $("paid-method").value || "—";
      const paidRef = dbInvoice?.paid_ref || ($("paid-ref").value || "—");

      $("r-paid-date").textContent = paidAt ? new Date(paidAt).toLocaleString("en-GB") : "—";
      $("r-method").textContent = paidMethod || "—";
      $("r-ref").textContent = paidRef || "—";

      // Receipt items
      const rList = $("r-item-list");
      rList.innerHTML = "";

      items.forEach(it => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-6 py-3 text-sm text-gray-900">${escapeHtml(it.desc)}${(it.date||it.time) ? ` <span class="text-xs text-gray-500">(${escapeHtml(it.date||"")}${it.time ? " " + escapeHtml(it.time) : ""})</span>` : ""}</td>
          <td class="px-6 py-3 text-right text-sm text-gray-700">${Number(it.qty||0)}</td>
          <td class="px-6 py-3 text-right text-sm text-gray-700">${Number(it.unit||0).toFixed(2)}</td>
          <td class="px-6 py-3 text-right text-sm font-medium text-gray-900">${Number(it.amount||0).toFixed(2)}</td>
        `;
        rList.appendChild(tr);
      });

      if (travel_fee !== 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-6 py-3 text-sm text-gray-900 font-semibold">Travel Fee</td>
          <td class="px-6 py-3 text-right text-sm text-gray-700">1</td>
          <td class="px-6 py-3 text-right text-sm text-gray-700">${Number(travel_fee).toFixed(2)}</td>
          <td class="px-6 py-3 text-right text-sm font-medium text-gray-900">${Number(travel_fee).toFixed(2)}</td>
        `;
        rList.appendChild(tr);
      }

      // Breakdown
      const breakdown = $("r-breakdown");
      breakdown.innerHTML = "";
      const balanceDue = Math.max(0, total - deposit_amount);

      if (programme === "school_band" && deposit_amount > 0) {
        breakdown.innerHTML = `
          <div class="flex justify-between"><span>Total (package):</span><span class="font-semibold">${fmtGBP(total)}</span></div>
          <div class="flex justify-between"><span>Stripe deposit already paid:</span><span class="font-semibold">${fmtGBP(deposit_amount)}</span></div>
          <div class="flex justify-between"><span class="font-bold">Payment received today:</span><span class="font-bold text-emerald-700">${fmtGBP(balanceDue)}</span></div>
        `;
        $("r-total").textContent = fmtGBP(total); // total paid to date
      } else {
        breakdown.innerHTML = "";
        $("r-total").textContent = fmtGBP(total);
      }
    }

    function autosaveSoon() {
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(saveDraft, 600);
    }

    function saveDraft() {
      const draft = {
        invoiceId: currentInvoiceId,
        customer: getCustomer(),
        invoice_no: $("invoice-number").value,
        due_date: $("due-date").value,
        programme: $("programme").value,
        travel_fee: $("travel-fee").value,
        deposit_amount: $("deposit-amount").value,
        notes: $("notes").value,
        items: getItems()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(draft));
    }

    function loadDraft() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const d = JSON.parse(raw);

        currentInvoiceId = d.invoiceId || null;

        $("client-name").value = d.customer?.name || "";
        $("client-email").value = d.customer?.email || "";
        $("client-address").value = d.customer?.address || "";

        $("invoice-number").value = d.invoice_no || $("invoice-number").value;
        $("due-date").value = d.due_date || $("due-date").value;

        $("programme").value = d.programme || "lessons";
        $("travel-fee").value = d.travel_fee || "0";
        $("deposit-amount").value = d.deposit_amount || "0";
        $("notes").value = d.notes || "";

        $("item-list").innerHTML = "";
        (d.items || []).forEach(it => addItem(it.desc, it.date, it.time, it.qty, it.unit));
        if ((d.items || []).length === 0) addItem();

        syncProgrammeUI(false);
        calculateTotal();
        return true;
      } catch {
        return false;
      }
    }

    function setDynamicFilename(prefix) {
      const name = ($("client-name").value || "Client").trim();
      const inv = ($("invoice-number").value || "Invoice").trim();
      const safeName = name.replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_\-]/g, "");
      document.title = `${prefix}_${inv}_${safeName}`;
    }

    function printMode(mode) {
      document.body.setAttribute("data-print-mode", mode);
      if (mode === "receipt") populateReceiptDocument();
      setTimeout(() => window.print(), 50);
    }

    async function markPaid() {
      // Always save first (so DB has latest totals/items)
      await saveInvoiceToCloud(true);
      if (!currentInvoiceId) throw new Error("Invoice not saved");

      const paid = getPaidPayload();
      const res = await api(`/api/invoices/${currentInvoiceId}/mark-paid`, {
        method: "POST",
        body: JSON.stringify(paid)
      });

      $("paid-stamp").classList.add("show");
      toast(res.emailed ? "Marked paid + receipt emailed ✅" : "Marked paid ✅ (email not sent)");

      // Reload from DB to show receipt_no etc
      await loadInvoiceFromCloud(currentInvoiceId);
    }

    async function markUnpaid() {
      if (!currentInvoiceId) { alert("Load or save an invoice first."); return; }
      await api(`/api/invoices/${currentInvoiceId}/mark-unpaid`, { method: "POST", body: "{}" });
      $("paid-stamp").classList.remove("show");
      toast("Marked unpaid");
    }

    async function resendReceipt() {
      if (!currentInvoiceId) { alert("Load or save an invoice first."); return; }
      const res = await api(`/api/invoices/${currentInvoiceId}/email-receipt`, { method: "POST", body: "{}" });
      toast(res.emailed ? "Receipt sent ✅" : "Receipt not sent (check email config)");
    }

    // Wire UI
    document.addEventListener("click", (e) => {
      // Click outside add-menu
      const menu = $("add-menu");
      const btn = $("add-item-btn");
      if (!menu.contains(e.target) && !btn.contains(e.target)) hideAddMenu();
    });

    window.addEventListener("load", async () => {
      const today = new Date().toISOString().split("T")[0];
      $("due-date").value = today;

      $("invoice-date").textContent =
        new Date().toLocaleDateString("en-GB", { year: "numeric", month: "long", day: "numeric" });

      if (!$("invoice-number").value) {
        $("invoice-number").value = "EW-" + Math.floor(10000 + Math.random() * 90000);
      }

      populateBlockLessonTypes();
      updateBlockPreview();

      // Load draft first
      const hadDraft = loadDraft();
      if (!hadDraft) addItem();

      // Programme UI
      syncProgrammeUI(false);

      // Try preload lists
      try { await refreshLists(); } catch {}

      // Hook events
      $("add-item-btn").addEventListener("click", toggleAddMenu);
      $("btn-add-single").addEventListener("click", () => { addItem(); hideAddMenu(); });

      ["block-start-date","block-start-time","block-weeks","block-lesson-type"].forEach(id => {
        $(id).addEventListener("change", () => { updateBlockPreview(); autosaveSoon(); });
      });
      $("btn-generate-block").addEventListener("click", generateBlock);

      $("programme").addEventListener("change", () => syncProgrammeUI(true));
      $("travel-fee").addEventListener("input", () => { calculateTotal(); autosaveSoon(); });
      $("deposit-amount").addEventListener("input", () => { calculateTotal(); autosaveSoon(); });

      ["client-name","client-email","client-address","invoice-number","due-date","notes"].forEach(id => {
        $(id).addEventListener("input", autosaveSoon);
        $(id).addEventListener("change", autosaveSoon);
      });

      $("btn-save-cloud").addEventListener("click", () => saveInvoiceToCloud(false));
      $("btn-refresh").addEventListener("click", refreshLists);
      $("btn-save-customer").addEventListener("click", saveCustomerToCloud);

      $("customer-picker").addEventListener("change", (e) => {
        const opt = e.target.selectedOptions[0];
        if (!opt || !opt.value) return;
        // Load into fields (no DB call needed)
        $("client-name").value = opt.textContent.split(" — ")[0] || "";
        $("client-email").value = opt.dataset.email || "";
        $("client-address").value = opt.dataset.address || "";
        autosaveSoon();
        toast("Customer loaded into form");
      });

      $("invoice-picker").addEventListener("change", async (e) => {
        const id = e.target.value;
        if (!id) return;
        await loadInvoiceFromCloud(id);
      });

      $("btn-mark-paid").addEventListener("click", () => markPaid().catch(err => alert(err.message)));
      $("btn-mark-unpaid").addEventListener("click", () => markUnpaid().catch(err => alert(err.message)));
      $("btn-email-receipt").addEventListener("click", () => resendReceipt().catch(err => alert(err.message)));

      $("btn-print-invoice").addEventListener("click", () => { setDynamicFilename("INVOICE"); printMode("invoice"); });
      $("btn-print-receipt").addEventListener("click", () => { setDynamicFilename("RECEIPT"); printMode("receipt"); });
    });
  </script>
</body>
</html>
